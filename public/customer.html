<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
  <title>Mi Cuenta ‚Äì Luber</title>
  <link rel="stylesheet" href="/css/customer.css"/>
  <style>
    .chat-close {
      float: right;
      font-size: 1.2rem;
      font-weight: bold;
      cursor: pointer;
      margin-left: 10px;
      color: #fff;
      transition: transform 0.2s ease;
    }
    .chat-close:hover {
      transform: scale(1.2);
    }
    /* Bot√≥n de cancelar cita */
    .cancel-btn {
      background-color: #e74c3c;
      color: #fff;
      border: none;
      padding: 6px 12px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.9rem;
      margin-top: 8px;
      transition: background-color 0.2s, transform 0.1s;
    }
    .cancel-btn:hover {
      background-color: #c0392b;
      transform: scale(1.02);
    }
    .cancel-btn:disabled {
      background-color: #bdc3c7;
      cursor: not-allowed;
      transform: none;
    }
    /* Secci√≥n de cancelaciones */
    .cancellations-container {
      margin-top: 32px;
      background: rgba(255,255,255,0.9);
      padding: 24px;
      border-radius: 10px;
      box-shadow: 0 8px 24px rgba(0,0,0,0.1);
    }
    .cancellations-container h2 {
      font-size: 1.5rem;
      margin-bottom: 8px;
    }
    .show-archived-toggle {
      margin-bottom: 16px;
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 1rem;
    }
    .show-archived-toggle input[type="checkbox"] {
      transform: scale(1.2);
      cursor: pointer;
    }
    .cancellation-card {
      background: #fff;
      border: 1px solid #ddd;
      border-radius: 8px;
      padding: 12px;
      margin-bottom: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.05);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .cancellation-info {
      display: flex;
      flex-direction: column;
      gap: 4px;
      font-size: 1rem;
    }
    .no-cancellations {
      text-align: center;
      font-size: 1.1rem;
      color: #555;
      margin-top: 12px;
    }
    .archive-toggle {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 0.9rem;
    }
    .archive-toggle input[type="checkbox"] {
      transform: scale(1.2);
      cursor: pointer;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <img id="profilePic" class="profile-pic" src="" alt="Foto de perfil"/>
      <div class="user-info">
        <h1 id="fullName">Usuario</h1>
        <div id="deniedReason"></div>
        <div class="field"><label>Tipo:</label><span id="accountType"></span></div>
        <div class="field"><label>Direcci√≥n:</label><span id="address"></span></div>
        <div class="field"><label>Tel√©fono:</label><span id="phone"></span></div>
        <div class="field"><label>Oficina:</label><span id="officePhone"></span></div>
        <div class="field"><label>Email:</label><span id="email"></span></div>
      </div>
      <button id="schedule-btn" class="schedule-btn">üóìÔ∏è Agendar Cita</button>
      <div class="company-logo"></div>
    </div>

    <div class="last-updated" id="lastUpdated">
      √öltima actualizaci√≥n: --:--:--  
    </div>

    <div class="vehicles">
      <h2>Mis Veh√≠culos</h2>
      <div id="vehiclesContainer" class="vehicle-grid"></div>
    </div>

    <!-- Secci√≥n para ver cancelaciones -->
    <div class="cancellations-container">
      <h2>Mis Cancelaciones</h2>
      <div class="show-archived-toggle">
        <input type="checkbox" id="showArchivedCheckbox"/>
        <label for="showArchivedCheckbox">Mostrar cancelaciones archivadas</label>
      </div>
      <div id="cancellationsContainer"></div>
      <div id="noCancellationsMsg" class="no-cancellations" style="display: none;">
        No tienes cancelaciones registradas.
      </div>
    </div>
  </div>

  <!-- Chat flotante -->
  <div id="chat-widget">
    <div id="chat-header">
      Chat con Luber
      <span id="chat-close" class="chat-close">&times;</span>
    </div>
    <div id="chat-body"></div>
    <form id="chat-form">
      <input type="text" id="chat-input" placeholder="Escribe tu mensaje‚Ä¶" autocomplete="off"/>
      <button type="submit">‚Ü©Ô∏è</button>
    </form>
  </div>

  <!-- Modal para imagen grande -->
  <div id="img-modal" class="modal">
    <span id="img-modal-close" class="modal-close">&times;</span>
    <img id="img-modal-full" class="modal-content"/>
  </div>

  <script>
    const fetchOpts = { credentials: 'same-origin' };
    let prevCount = 0, chatOpen = false, customerInfo = {};

    function linkify(text) {
      return text.replace(/(\bhttps?:\/\/[^\s]+)/g, url => `<a href="${url}" target="_blank">${url}</a>`);
    }

    async function loadProfile() {
      const res = await fetch('/api/customer-profile', fetchOpts);
      if (!res.ok) return;
      const d = await res.json();

      if (d.accountType === 'Fleet') {
        window.location.href = '/fleet.html';
        return;
      }

      customerInfo = {
        id:      d._id,
        name:    d.fullName,
        email:   d.email,
        address: d.address
      };

      document.getElementById('fullName').textContent    = d.fullName;
      document.getElementById('accountType').textContent = d.accountType;
      document.getElementById('address').textContent     = d.address;
      document.getElementById('phone').textContent       = d.phone;
      document.getElementById('officePhone').textContent = d.officePhone;
      document.getElementById('email').textContent       = d.email;
      document.getElementById('profilePic').src          = d.profilePictureUrl || '/images/default-profile.png';

      // Cargar citas
      const schRes = await fetch(`/api/schedule?userId=${d._id}`, fetchOpts);
      const schedules = schRes.ok ? await schRes.json() : [];

      const denied = schedules.find(s =>
        s.reason && s.reason.trim().toLowerCase() !== 'awaiting reason'
      );
      const reasonEl = document.getElementById('deniedReason');
      if (denied) {
        reasonEl.innerHTML = `‚ùå Tu servicio fue rechazado por la siguiente raz√≥n:<br><em>${denied.reason}</em>`;
      } else {
        reasonEl.innerHTML = '';
      }

      renderVehicles(d.vehicles, schedules);
      renderCancellations(d.cancellations || []);
      updateTimestamp();
      setupScheduleButton();
    }

    function renderVehicles(vehicles, schedules) {
      const grid = document.getElementById('vehiclesContainer');
      grid.innerHTML = '';
      vehicles.forEach(v => {
        const related = schedules.filter(s =>
          s.vehicles.some(item => String(item.vehicleId) === String(v._id))
        );
        const next = related.sort((a,b) => {
          const [timeA, suffixA] = a.time.split(' ');
          const [hA, mA] = timeA.split(':').map(Number);
          let hourA = (suffixA === 'PM' && hA < 12) ? hA + 12 : (suffixA === 'AM' && hA === 12 ? 0 : hA);
          const dateA = new Date(a.date);
          dateA.setHours(hourA, mA, 0, 0);

          const [timeB, suffixB] = b.time.split(' ');
          const [hB, mB] = timeB.split(':').map(Number);
          let hourB = (suffixB === 'PM' && hB < 12) ? hB + 12 : (suffixB === 'AM' && hB === 12 ? 0 : hB);
          const dateB = new Date(b.date);
          dateB.setHours(hourB, mB, 0, 0);

          return dateA - dateB;
        })[0];

        const dateText = next
          ? `${new Date(next.date).toLocaleDateString('es-ES',{day:'2-digit',month:'2-digit',year:'numeric'})} a las ${next.time}`
          : 'Sin cita';

        const deniedIcon = next?.reason && next.reason.trim().toLowerCase() !== 'awaiting reason'
          ? '<span class="denied-icon"></span>' : '';

        const icons = next
          ? `${next.processed ? '<span class="processed-icon"></span>' : ''}
             ${next.confirmed ? '<span class="approved-icon"></span>' : ''}
             ${deniedIcon}`
          : '';

        const note = `<div class="vehicle-note">
                        ${icons}
                        Pr√≥xima cita: ${dateText}
                      </div>`;

        const card = document.createElement('div');
        card.className = 'vehicle';
        card.innerHTML = `
        ${v.vehicleImageUrl
          ? `<img src="${v.vehicleImageUrl}" alt="Veh√≠culo"/>`
          : `<div style="height:140px;background:#ddd;"></div>`}
        <div class="vehicle-details">
          <div><strong>Marca:</strong> ${v.brand}</div>
          <div><strong>A√±o:</strong> ${v.year}</div>
          <div><strong>Modelo:</strong> ${v.model}</div>
          <div><strong>Motor:</strong> ${v.engine}</div>
          <div><strong>Color:</strong> ${v.color}</div>
          <div><strong>Placa:</strong> ${v.plateLast3}</div>
          ${v.vinImageUrl
            ? `<img src="${v.vinImageUrl}" alt="VIN" style="margin:8px 0;border-radius:4px;max-width:100%;"/>`
            : ''}
          <div><strong>VIN:</strong> ${v.vin || '‚Äî'}</div>
        </div>
        <div class="vehicle-interval">Intervalo: ${v.interval} km/d√≠as</div>
        ${note}
      `;

        if (next) {
          const apptDateObj = new Date(next.date + 'T00:00:00');
          const todayObj = new Date();
          todayObj.setHours(0, 0, 0, 0);
          const diffMs = apptDateObj - todayObj;
          const diffDays = diffMs / (1000 * 60 * 60 * 24);
          if (diffDays >= 1) {
            const btn = document.createElement('button');
            btn.className = 'cancel-btn';
            btn.textContent = 'Cancelar Cita';
            btn.dataset.id = next._id;
            btn.onclick = handleCancel;
            card.appendChild(btn);
          }
        }

        grid.appendChild(card);
      });
    }

    function renderCancellations(cancellations) {
      const container = document.getElementById('cancellationsContainer');
      const noMsg = document.getElementById('noCancellationsMsg');
      container.innerHTML = '';

      const showArchived = document.getElementById('showArchivedCheckbox').checked;
      // Filtrar seg√∫n archived
      const filtered = cancellations.filter(c => showArchived ? c.archived : !c.archived);

      if (!filtered || filtered.length === 0) {
        noMsg.style.display = 'block';
        return;
      }
      noMsg.style.display = 'none';

      filtered.sort((a, b) => new Date(b.date) - new Date(a.date));

      filtered.forEach(entry => {
        const card = document.createElement('div');
        card.className = 'cancellation-card';

        const info = document.createElement('div');
        info.className = 'cancellation-info';

        const fechaTexto = new Date(entry.date).toLocaleDateString('es-ES', {
          day: '2-digit', month: '2-digit', year: 'numeric'
        });
        info.innerHTML = `
          <div><strong>Fecha de cancelaci√≥n:</strong> ${fechaTexto}</div>
          <div><strong>Servicio:</strong> ${entry.serviceName}</div>
          <div><strong>Veh√≠culo:</strong> ${entry.vehicleInfo.brand} ${entry.vehicleInfo.model} (${entry.vehicleInfo.plateLast3})</div>
        `;

        const toggleDiv = document.createElement('div');
        toggleDiv.className = 'archive-toggle';
        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.checked = entry.archived;
        checkbox.dataset.date = entry.date;
        checkbox.onclick = () => handleArchiveToggle(entry.date);
        const label = document.createElement('label');
        label.textContent = 'Archivada';
        toggleDiv.appendChild(checkbox);
        toggleDiv.appendChild(label);

        card.appendChild(info);
        card.appendChild(toggleDiv);
        container.appendChild(card);
      });
    }

    async function handleCancel(e) {
      const scheduleId = e.currentTarget.dataset.id;
      if (!scheduleId) return;
      const confirmar = confirm('¬øSeguro que deseas cancelar esta cita? Debes hacerlo al menos con un d√≠a de anticipaci√≥n.');
      if (!confirmar) return;
      try {
        const res = await fetch(`/api/schedule/${scheduleId}`, {
          method: 'DELETE',
          ...fetchOpts
        });
        if (!res.ok) {
          const errText = await res.text();
          alert('Error al cancelar: ' + errText);
          return;
        }
        await loadProfile();
      } catch (err) {
        console.error('Error cancelando cita:', err);
        alert('Ocurri√≥ un error cancelando la cita.');
      }
    }

    async function handleArchiveToggle(dateStr) {
      try {
        const res = await fetch(`/api/customer-cancellation-archive`, {
          method: 'PUT',
          ...fetchOpts,
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ date: dateStr })
        });
        if (!res.ok) {
          const errText = await res.text();
          alert('Error al actualizar archivado: ' + errText);
          return;
        }
        await loadProfile();
      } catch (err) {
        console.error('Error archivando/unarchivando:', err);
        alert('Ocurri√≥ un error al actualizar archivado.');
      }
    }

    function updateTimestamp() {
      const now = new Date();
      document.getElementById('lastUpdated').textContent =
        `√öltima actualizaci√≥n: ${now.toLocaleTimeString()}`;
    }

    function setupScheduleButton() {
      document.getElementById('schedule-btn').onclick = () => {
        const qs = new URLSearchParams({
          clientId: customerInfo.id,
          name:     customerInfo.name,
          email:    customerInfo.email,
          address:  customerInfo.address
        }).toString();
        window.location.href = `/schedule.html?${qs}`;
      };
    }

    async function loadChat() {
      const res = await fetch('/api/chat/history', fetchOpts);
      if (!res.ok) return;
      const msgs = await res.json();
      const body = document.getElementById('chat-body');
      body.innerHTML = '';
      msgs.forEach(m => {
        const d = document.createElement('div');
        d.className = 'msg ' + m.sender;
        if (m.text) d.innerHTML = linkify(m.text);
        if (m.imageUrl) {
          const img = document.createElement('img');
          img.src = m.imageUrl;
          img.className = 'chat-thumb';
          img.onclick = () => openModal(m.imageUrl);
          d.appendChild(img);
        }
        body.appendChild(d);
      });
      body.scrollTop = body.scrollHeight;
      if (msgs.length > prevCount && !chatOpen) {
        document.getElementById('chat-widget').classList.add('unread');
      }
      prevCount = msgs.length;
    }

    document.getElementById('showArchivedCheckbox').addEventListener('change', () => {
      // Volver a renderizar cancelaciones al alternar
      fetch('/api/customer-profile', fetchOpts)
        .then(res => res.json())
        .then(data => renderCancellations(data.cancellations || []))
        .catch(() => {});
    });

    document.getElementById('chat-header').onclick = () => {
      chatOpen = !chatOpen;
      document.getElementById('chat-widget').classList.toggle('open', chatOpen);
      if (chatOpen) document.getElementById('chat-widget').classList.remove('unread');
    };

    document.getElementById('chat-close').onclick = (e) => {
      e.stopPropagation();
      chatOpen = false;
      document.getElementById('chat-widget').classList.remove('open');
    };

    document.getElementById('chat-form').onsubmit = async e => {
      e.preventDefault();
      const text = document.getElementById('chat-input').value.trim();
      if (!text) return;
      await fetch('/api/chat/send', {
        ...fetchOpts,
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ text })
      });
      document.getElementById('chat-input').value = '';
      loadChat();
    };

    document.getElementById('img-modal-close').onclick = () =>
      document.getElementById('img-modal').style.display = 'none';

    function openModal(src) {
      document.getElementById('img-modal-full').src = src;
      document.getElementById('img-modal').style.display = 'flex';
    }

    window.addEventListener('DOMContentLoaded', () => {
      loadProfile();
      setInterval(loadProfile, 15000);
      loadChat();
      setInterval(loadChat, 5000);
    });
  </script>
</body>
</html>
